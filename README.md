# gamepad_display_v7

格闘ゲーム用ゲームパッド入力表示・解析システム（Sony Spresense版）

![Version](https://img.shields.io/badge/version-7.0-blue)
![Platform](https://img.shields.io/badge/platform-Spresense-green)
![Status](https://img.shields.io/badge/status-stable-brightgreen)

## 概要

ゲームパッドの入力をリアルタイムで可視化し、格闘ゲームのコマンド入力を解析・計測するシステムです。Spresenseのマルチコアアーキテクチャを活用し、高精度な入力表示と反応速度測定を実現しています。

### 主な機能

- **リアルタイム入力表示** - 方向キー、ボタンを1フレーム単位で表示
- **入力履歴** - 最大12行の履歴を表示（フレーム数付き）
- **コマンド判定** - 波動拳、昇竜拳、スーパーアーツを自動判定
- **反応速度テスト** - カメラとボタン入力で反応時間を計測
- **ボタン押下時間計測** - 0.1ms単位でボタン押下時間を測定
- **カメラプレビュー** - QQVGA (160x120) でカメラ映像を表示
- **コンボキャプチャ** - コマンド成功時の画像をキャプチャ

## ハードウェア要件

### 必須

- Sony Spresense メインボード
- Spresense LCD拡張ボード (ILI9341, 320x240)
- ゲームパッド（UART通信対応）

### オプション

- Spresense カメラモジュール（反応速度テスト機能用）

## ソフトウェア要件

- Arduino IDE 1.8.x 以降
- Spresense Arduino ボードパッケージ
- LovyanGFX ライブラリ

## インストール

### 1. Arduino IDE のセットアップ

1. Arduino IDE を起動
2. **ファイル** → **環境設定** → **追加のボードマネージャURL** に以下を追加:
   ```
   https://github.com/sonydevworld/spresense-arduino-compatible/releases/download/generic/package_spresense_index.json
   ```
3. **ツール** → **ボード** → **ボードマネージャ** から「Spresense」をインストール

### 2. ライブラリのインストール

1. **スケッチ** → **ライブラリをインクルード** → **ライブラリを管理**
2. 「LovyanGFX」を検索してインストール

### 3. プロジェクトのビルド

#### MainCore のアップロード

1. `gamepad_display_v7.ino` を開く
2. **ツール** → **Core** → **MainCore** を選択
3. アップロード

#### SubCore1 のアップロード

1. `SubCore1/SubCore1.ino` を開く
2. **ツール** → **Core** → **SubCore1** を選択
3. アップロード

#### SubCore2 のアップロード

1. `SubCore2/SubCore2.ino` を開く
2. **ツール** → **Core** → **SubCore2** を選択
3. アップロード

#### SubCore3 のアップロード

1. `SubCore3/SubCore3.ino` を開く
2. **ツール** → **Core** → **SubCore3** を選択
3. アップロード

## 使い方

### 基本操作

1. Spresenseを起動
2. ゲームパッドを接続
3. LCD画面に入力が表示されます

### 画面の見方

```
┌──────────────────────────┬────────────┐
│ 現在入力                  │  カメラ    │
│ 1.0F  ↓↘→  LP           │  プレビュー│
├──────────────────────────┼────────────┤
│ 入力履歴                  │  コンボ    │
│ 1. 2.0F  →     LP        │ キャプチャ │
│ 2. 1.0F  ↓     -         │            │
│ 3. 1.5F  ↘     -         │            │
│ ...                      │            │
├──────────────────────────┼────────────┤
│ Action:  123.4 ms        │  ボタン    │
│ React:   234.5 ms        │  パネル    │
│ Btn: 12.3 ms  30/s       │            │
└──────────────────────────┴────────────┘
```

### コマンド入力

以下のコマンドが自動判定されます：

| コマンド | 入力 | 表示色 |
|---------|------|--------|
| 波動拳 | ↓↘→ + ボタン | 黄色 |
| 昇竜拳 | →↓↘ + ボタン | オレンジ |
| スーパーアーツ | 波動拳×2 | シアン |

### 反応速度テスト

システムが自動的に5〜10秒ごとにマーカーを表示します：

- **Action時間**: マーカー表示から身体が動き始めるまで（カメラで検出）
- **React時間**: マーカー表示からボタンを押すまで

## アーキテクチャ

### コア構成

```
MainCore  - カメラストリーミング、メッセージルーティング、画像差分検出
  ├─ SubCore1 - ゲームパッドUART受信、入力処理
  ├─ SubCore2 - LCD描画、履歴管理、UI表示
  └─ SubCore3 - コマンド解析、SOCD処理、統計計測
```

### データフロー

```
ゲームパッド → SC1 → MainCore
                        ├→ SC2 (履歴表示, 1F単位)
                        └→ SC3 (コマンド解析, 即時)
                              ↓
                         MainCore → SC2 (色更新)
```

## 性能

| 項目 | 値 |
|-----|-----|
| MainCore ループ周波数 | 約124-126kHz |
| 入力表示レイテンシ | <33ms (1フレーム以内) |
| カメラフレームレート | 30fps |
| 入力精度 | 1フレーム (16.67ms) 単位 |
| ボタン計測精度 | 0.1ms 単位 |

## 設定

### カメラ差分検出の調整

`gamepad_display_v7.ino` で以下を変更：

```cpp
#define PIXEL_DIFF_THRESHOLD 30  // ピクセル差分閾値（大きいほど鈍感）
#define MOTION_PIXEL_COUNT   15  // 変化ピクセル数閾値（大きいほど鈍感）
```

### コマンド判定猶予の調整

`SubCore3/SubCore3.ino` で以下を変更：

```cpp
static const int HADOUKEN_DIR_MAX_FRAMES = 11;  // 波動拳の方向キー猶予
static const int HADOUKEN_BTN_MAX_FRAMES = 9;   // 波動拳のボタン猶予
```

### クールダウン時間の調整

```cpp
static const unsigned long COMBO_COOLDOWN_MS = 800;  // コンボクールダウン
```

## トラブルシューティング

### カメラが映らない

**症状**: カメラプレビューが真っ黒

**対処**:
1. カメラケーブルを再接続
2. Spresenseを再起動
3. シリアルモニタで `カメラ初期化...NG` が出ていないか確認

### 履歴が表示されない

**症状**: 入力しても履歴が空白

**対処**:
1. シリアルモニタで `MSG_GAMEPAD` の送信を確認
2. MainCore を再アップロード
3. SubCore2 を再アップロード

### コンボが検出されない

**症状**: 正しく入力してもコマンドが認識されない

**対処**:
1. より速く入力する（11フレーム以内）
2. 方向キーとボタンの同時押しを避ける
3. 前回のコンボから800ms以上待つ

### システムがリブートする

**症状**: 定期的に再起動する

**対処**:
1. クールダウン時間を増やす（1000ms程度）
2. シリアルモニタのログ出力を削減
3. カメラモジュールを外して動作確認

## 技術詳細

詳細な技術仕様は [`仕様書.md`](./仕様書.md) を参照してください。

### 主要な技術トピック

- **マルチコアMP通信**: Spresenseの4コアを活用した並列処理
- **通信最適化**: SubCore2への履歴送信を1フレーム単位にまとめて通信量を50-70%削減
- **SOCD処理**: 同時反対方向入力の解決
- **画像差分検出**: RGB565形式でのピクセル単位差分検出
- **クールダウン管理**: メッセージキュー飽和を防ぐための判定制限

## 開発履歴

### v7 (2026-01-24) - 現在

**新機能**:
- 反応速度テスト機能（Action/React時間計測）
- カメラ画像差分検出
- USB電源管理（D02ピン制御）
- LED制御の再定義（接続状態/マーカー同期）

**最適化**:
- SubCore2への通信を1フレーム単位に削減
- カメラ差分検出感度の調整
- コンボ判定クールダウンの実装（800ms）

**基盤**: v5（安定版）から再スタート

### 以前のバージョン

- **v6**: 安定性の問題により廃止
- **v5**: 安定版（v7のベース）
- **v1-v4**: 初期開発版

## サポート

技術的な質問や問題がある場合は、以下を参照してください：

1. [`仕様書.md`](./仕様書.md) - 詳細な技術仕様
2. シリアルモニタのログ（115200 bps）
3. 付録A: トラブルシューティング（仕様書内）

---

**Last Updated**: 2026-01-24  
**Version**: 7.0  
**Status**: Stable


